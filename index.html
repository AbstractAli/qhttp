<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="QHttp (Qt HTTP server+client) : a light-weight and asynchronous (non-blocking) HTTP library (both server and client) in Qt 5 and c++11 which is based on Node.js&#39; http parser." />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>QHttp (Qt HTTP server+client)</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/azadkuh/qhttp">View on GitHub</a>

          <h1 id="project_title">QHttp (Qt HTTP server+client)</h1>
          <h2 id="project_tagline">a light-weight and asynchronous (non-blocking) HTTP library (both server and client) in Qt 5 and c++11 which is based on Node.js&#39; http parser.</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/azadkuh/qhttp/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/azadkuh/qhttp/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a name="qhttp" class="anchor" href="#qhttp"><span class="octicon octicon-link"></span></a>QHttp</h1>

<h3>
<a name="table-of-contents" class="anchor" href="#table-of-contents"><span class="octicon octicon-link"></span></a>Table of contents</h3>

<ul>
<li><a href="#about">About</a></li>
<li><a href="#features">Features</a></li>
<li><a href="#sample-codes">Sample codes</a></li>
<li><a href="#setup">Setup</a></li>
<li><a href="#multi-threading">Multi-threading</a></li>
<li><a href="#disclaimer">Disclaimer</a></li>
<li><a href="#license">License</a></li>
</ul><h2>
<a name="about" class="anchor" href="#about"><span class="octicon octicon-link"></span></a>About</h2>

<p><a href="#table-of-contents">TOC</a></p>

<p><code>QHttp</code> is a lightweight, asynchronous and fast HTTP library, containing both server and client side classes for managing connections, parsing and building HTTP requests and responses.</p>

<ul>
<li><p>this project is inspired by <a href="https://github.com/nikhilm/qhttpserver">nikhilm/qhttpserver</a> effort to implement a Qt HTTP server. <code>QHttp</code> pushes the idea further by implementing client classes and better memory management, a lot more Node.js-like API, ...</p></li>
<li><p>the fantastic <a href="https://github.com/joyent/http-parser">joyent/http-parser</a> is the core parser of HTTP requests (server mode) and responses (client mode). </p></li>
<li><p>By using <code>std::function</code> and <code>c++11 lambda</code>, the API is intentionally similar to the <a href="http://nodejs.org/api/http.html">Node.js' http module</a>. Asynchronous and non-blocking HTTP programming is quite easy with <code>QHttp</code>. have a look at <a href="#sample-codes">sample codes</a>.</p></li>
<li><p>the objective of <code>QHttp</code> is being light weight with a simple API for Qt developers to implement RESTful web services in private (internal) zones. for a fast c++ Json parser / builder, have a look at <a href="https://github.com/azadkuh/gason--">azadkuh/gason++</a></p></li>
</ul><h2>
<a name="features" class="anchor" href="#features"><span class="octicon octicon-link"></span></a>Features</h2>

<p><a href="#table-of-contents">TOC</a></p>

<ul>
<li><p>the only dependencies are: <a href="http://qt-project.org/downloads">Qt 5</a>, <a href="http://en.wikipedia.org/wiki/C%2B%2B11">c++11</a> and <a href="https://github.com/joyent/http-parser">joyent/http-parser</a></p></li>
<li><p>both TCP and UNIX (local) sockets are supported as backend.</p></li>
<li><p>separate <code>namespace</code>s for server and client classes.</p></li>
<li><p>HTTP server classes: <code>QHttpServer</code>, <code>QHttpConnection</code>, <code>QHttpRequest</code> and <code>QHttpResponse</code>.</p></li>
<li><p>HTTP client classes: <code>QHttpClient</code>, <code>QHttpRequest</code> and <code>QHttpResponse</code>.</p></li>
<li><p><strong>automatic memory management</strong> of objects. Instances of connections, requests and replies will be deleted automatically when socket drops or disconnected.</p></li>
<li><p><strong>PIMPL</strong> (Private classes) to achieve better ABI compatibility and cleaner API.</p></li>
<li><p><strong>Asynchronous</strong> and <strong>non-blocking</strong>. You can handle thousands of concurrent HTTP connections efficiently by a single thread, although a multi-threaded HTTP server is easy to implement.</p></li>
<li><p><strong>high throughput</strong>, I have tried the <code>QHttp</code> and <a href="https://github.com/azadkuh/gason--">gason++</a> to implement a REST/Json web service on an Ubuntu VPS (dual core + 512MB ram) with more than <strong>5000</strong> connections per second (stress test). On a MacBook Pro (i5 quadcore + 8096MB ram), <code>QHttp</code> easily reaches to more than <strong>8000</strong> connections / second. see also <code>./example/benchmark</code>.</p></li>
<li><p>Tested under <strong>Linux</strong> (Ubuntu 12.04 LTS, 14.04 LTS, gcc) and <strong>OS X</strong> (10.9, clang). Easily portable where ever Qt 5 works. I have no <em>Windows</em> machine (nor time, nor interest), but this lib should work just fine under <em>Windows</em>, although I've not tried by myself.</p></li>
</ul><h2>
<a name="sample-codes" class="anchor" href="#sample-codes"><span class="octicon octicon-link"></span></a>Sample codes</h2>

<p><a href="#table-of-contents">TOC</a></p>

<p>a HelloWorld <strong>HTTP server</strong> by <code>QHttp</code> looks like:</p>

<div class="highlight highlight-cpp"><pre><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">QCoreApplication</span> <span class="n">app</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

    <span class="k">using</span> <span class="k">namespace</span> <span class="n">qhttp</span><span class="o">::</span><span class="n">server</span><span class="p">;</span>

    <span class="n">QHttpServer</span> <span class="n">server</span><span class="p">(</span><span class="o">&amp;</span><span class="n">app</span><span class="p">);</span>
    <span class="c1">// listening on 0.0.0.0:8080</span>
    <span class="n">server</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="n">QHostAddress</span><span class="o">::</span><span class="n">Any</span><span class="p">,</span> <span class="mi">8080</span><span class="p">,</span> <span class="p">[](</span><span class="n">QHttpRequest</span><span class="o">*</span> <span class="n">req</span><span class="p">,</span> <span class="n">QHttpResponse</span><span class="o">*</span> <span class="n">res</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">res</span><span class="o">-&gt;</span><span class="n">setStatusCode</span><span class="p">(</span><span class="n">qhttp</span><span class="o">::</span><span class="n">ESTATUS_OK</span><span class="p">);</span>      <span class="c1">// status 200</span>
        <span class="n">res</span><span class="o">-&gt;</span><span class="n">addHeader</span><span class="p">(</span><span class="s">"connection"</span><span class="p">,</span> <span class="s">"close"</span><span class="p">);</span>      <span class="c1">// it's the default header, this line can be omitted.</span>
        <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">(</span><span class="s">"Hello World!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>                 <span class="c1">// response body data</span>

        <span class="c1">// when "connection: close", the req and res will be deleted automatically.</span>
    <span class="p">});</span>


    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">server</span><span class="p">.</span><span class="n">isListening</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"failed. can not listen at port 8080!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// application's main event loop</span>
    <span class="k">return</span> <span class="n">app</span><span class="p">.</span><span class="n">exec</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<p>to request weather information by <strong>HTTP client</strong>:</p>

<div class="highlight highlight-cpp"><pre><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">QCoreApplication</span> <span class="n">app</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
    <span class="k">using</span> <span class="k">namespace</span> <span class="n">qhttp</span><span class="o">::</span><span class="n">client</span><span class="p">;</span>

    <span class="n">QHttpClient</span>  <span class="n">client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">app</span><span class="p">);</span>
    <span class="n">QByteArray</span>   <span class="n">httpBody</span><span class="p">;</span>

    <span class="n">QUrl</span> <span class="n">weatherUrl</span><span class="p">(</span><span class="s">"http://api.openweathermap.org/data/2.5/weather?q=tehran,ir&amp;units=metric&amp;mode=xml"</span><span class="p">);</span>

    <span class="n">client</span><span class="p">.</span><span class="n">request</span><span class="p">(</span><span class="n">qhttp</span><span class="o">::</span><span class="n">EHTTP_GET</span><span class="p">,</span> <span class="n">weatherUrl</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">httpBody</span><span class="p">](</span><span class="n">QHttpResponse</span><span class="o">*</span> <span class="n">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// response handler, called when the HTTP headers of the response are ready</span>

        <span class="c1">// gather HTTP response data</span>
        <span class="n">res</span><span class="o">-&gt;</span><span class="n">onData</span><span class="p">([</span><span class="o">&amp;</span><span class="n">httpBody</span><span class="p">](</span><span class="k">const</span> <span class="n">QByteArray</span><span class="o">&amp;</span> <span class="n">chunk</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">httpBody</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="c1">// called when all data in HTTP response have been read.</span>
        <span class="n">res</span><span class="o">-&gt;</span><span class="n">onEnd</span><span class="p">([</span><span class="o">&amp;</span><span class="n">httpBody</span><span class="p">]()</span> <span class="p">{</span>
            <span class="c1">// print the XML body of the response</span>
            <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[incoming response:]"</span><span class="p">);</span>
            <span class="n">puts</span><span class="p">(</span><span class="n">httpBody</span><span class="p">.</span><span class="n">constData</span><span class="p">());</span>
            <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>

            <span class="n">QCoreApplication</span><span class="o">::</span><span class="n">instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">quit</span><span class="p">();</span>
        <span class="p">});</span>

        <span class="c1">// just for fun! print headers:</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">[Headers:]"</span><span class="p">);</span>
        <span class="k">const</span> <span class="n">qhttp</span><span class="o">::</span><span class="n">THeaderHash</span><span class="o">&amp;</span> <span class="n">hs</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">headers</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span> <span class="k">auto</span> <span class="n">cit</span> <span class="o">=</span> <span class="n">hs</span><span class="p">.</span><span class="n">constBegin</span><span class="p">();</span> <span class="n">cit</span> <span class="o">!=</span> <span class="n">hs</span><span class="p">.</span><span class="n">constEnd</span><span class="p">();</span> <span class="n">cit</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"%s : %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">cit</span><span class="p">.</span><span class="n">key</span><span class="p">().</span><span class="n">constData</span><span class="p">(),</span> <span class="n">cit</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">constData</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">});</span>


    <span class="k">return</span> <span class="n">app</span><span class="p">.</span><span class="n">exec</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>

<h2>
<a name="setup" class="anchor" href="#setup"><span class="octicon octicon-link"></span></a>Setup</h2>

<p><a href="#table-of-contents">TOC</a></p>

<p>instructions:</p>

<div class="highlight highlight-bash"><pre><span class="c"># first clone this repository:</span>
<span class="nv">$&gt;</span> git clone --depth<span class="o">=</span><span class="m">1</span> https://github.com/azadkuh/qhttp.git -b master
<span class="nv">$&gt;</span> <span class="nb">cd </span>qhttp

<span class="c"># prepare dependencies:</span>
<span class="nv">$&gt;</span> ./update-dependencies.sh

<span class="c"># now build the library and the examples</span>
<span class="nv">$&gt;</span> qmake qhttp.pro
<span class="nv">$&gt;</span> make -j 8
</pre></div>

<h2>
<a name="multi-threading" class="anchor" href="#multi-threading"><span class="octicon octicon-link"></span></a>Multi-threading</h2>

<p><a href="#table-of-contents">TOC</a></p>

<p>As <code>QHttp</code> is <strong>asynchrounous</strong> and <strong>non-bloking</strong>, your app can handle thousands of concurrent HTTP connections by a single thread. </p>

<p>in some rare scenarios you may want to use multiple threads (which is highly unwelcomed):</p>

<ul>
<li><p>there are some blocking APIs (QSql, system calls, ...) in your connection handler (although adopting asynchronous layer over the blocking API is a better approach).</p></li>
<li><p>the hardware has lots of free cores and you've measured the load on the main thread reaches to the highest limit. there you can spawn some other working threads.</p></li>
</ul><p><code>./example/benchmark</code> shows how to implement a single or multi threaded HTTP app (server or client). This example uses worker <code>QThread</code> and <code>QObject::moveToThread()</code> for worker objects. see aslo: <a href="http://qt-project.org/doc/note_revisions/5/8/view">Subclassing no longer recommended way of using QThread</a>.</p>

<p><strong>Note</strong>:</p>

<blockquote>
<p>moving objects between threads is an expensive job, more ever the locking/unlocking mechanism, creating or stopping threads, ... cost even more! so using multiple threads in an application is not guaranteed to get better performance, but it's guaranteed to add more complexity, nasty bugs and headache!</p>
</blockquote>

<p>see why other top performer networking libraries as ZeroMQ are concurrent but not multi-threaded by default:</p>

<ul>
<li><a href="http://zeromq.org/blog:multithreading-magic">ZeroMQ : Multithreading Magic</a></li>
<li><a href="http://nodejs.org/about/">Node.j : about</a></li>
</ul><h2>
<a name="disclaimer" class="anchor" href="#disclaimer"><span class="octicon octicon-link"></span></a>Disclaimer</h2>

<p><a href="#table-of-contents">TOC</a></p>

<ul>
<li><p>Implementing a lightweight and simple HTTP server/client in Qt with Node.js like API, is the main purpose of <code>QHttp</code>.</p></li>
<li><p>There are lots of features in a full blown HTTP server which are out of scope of this small library, although those can be added on top of <code>QHttp</code>.</p></li>
<li><p>The client classes are by no mean designed as a <code>QNetworkAccessManager</code> replacement. <code>QHttpClient</code> is simpler and lighter, for serious scenarios just use <code>QNetworkAccessManager</code>.</p></li>
<li><p>I'm a busy person.</p></li>
</ul><blockquote>
<p>If you have any ideas, critiques, suggestions or whatever you want to call it, please open an issue. I'll be happy to hear from you what you'd see in this lib. I think about all suggestions, and I try to add those that make sense.</p>
</blockquote>

<h2>
<a name="license" class="anchor" href="#license"><span class="octicon octicon-link"></span></a>License</h2>

<p><a href="#table-of-contents">TOC</a></p>

<p>Distributed under the MIT license. Copyright (c) 2014, Amir Zamani.</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">QHttp (Qt HTTP server+client) maintained by <a href="https://github.com/azadkuh">azadkuh</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
